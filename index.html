<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DebtFree Compass - Loan Management</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --box-shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            background: white;
            color: var(--primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid white;
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.875rem;
        }

        /* Auth Pages */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .auth-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-lg);
            padding: 40px;
            width: 100%;
            max-width: 450px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            margin-bottom: 10px;
            color: var(--dark);
        }

        .auth-header p {
            color: var(--gray);
        }

        .auth-form .form-group {
            margin-bottom: 20px;
        }

        .auth-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .auth-form input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .auth-form .btn {
            width: 100%;
            padding: 14px;
            margin-top: 10px;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            color: var(--gray);
        }

        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--light-gray);
        }

        .divider span {
            padding: 0 10px;
            color: var(--gray);
        }

        /* Main App Styles */
        .app-view {
            display: none;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin: 24px 0;
            box-shadow: var(--box-shadow);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
        }

        .tab:hover:not(.active) {
            background: var(--light-gray);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 24px;
            margin-bottom: 24px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--box-shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--light-gray);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .loans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .loan-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
        }

        .loan-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }

        .loan-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 16px;
        }

        .loan-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .loan-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
        }

        .loan-body {
            padding: 16px;
        }

        .loan-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat {
            text-align: center;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress {
            height: 100%;
            background: var(--secondary);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .loan-footer {
            display: flex;
            justify-content: space-between;
            padding: 0 16px 16px;
        }

        .chart-container {
            height: 200px;
            margin: 16px 0;
        }

        /* Privacy Policy */
        .privacy-container {
            max-width: 800px;
            margin: 40px auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
        }

        .privacy-container h1 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .privacy-container h2 {
            margin: 25px 0 15px;
            color: var(--primary);
        }

        .privacy-container p {
            margin-bottom: 15px;
            line-height: 1.7;
        }

        .privacy-container ul {
            margin: 15px 0 15px 30px;
        }

        .privacy-container li {
            margin-bottom: 10px;
        }

        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 30px 0;
            margin-top: 50px;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-links a {
            color: white;
            margin-left: 20px;
            text-decoration: none;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .loans-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 16px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 33%;
            }
            
            .footer-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .footer-links {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .footer-links a {
                margin: 0;
            }
            
            .auth-card {
                padding: 25px;
            }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-lg);
            color: var(--dark);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.info {
            border-left: 4px solid var(--primary);
        }

        /* User info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary);
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <!-- Toast notifications -->
    <div id="toast" class="toast"></div>

    <!-- Header with Logo and Auth Buttons -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">DF</div>
                    <div class="logo-text">DebtFree Compass</div>
                </div>
                <div id="authButtons" class="auth-buttons">
                    <button id="loginBtn" class="btn btn-outline">Log In</button>
                    <button id="signupBtn" class="btn">Sign Up</button>
                </div>
                <div id="userSection" style="display: none;" class="user-info">
                    <div id="userAvatar" class="user-avatar"></div>
                    <button id="logoutBtn" class="btn btn-sm btn-outline">Log Out</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Auth Views -->
    <div id="authViews">
        <!-- Sign Up View -->
        <div id="signupView" class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h2>Create Your Account</h2>
                    <p>Start your journey to becoming debt-free</p>
                </div>
                <form id="signupForm" class="auth-form">
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password (min 6 characters)</label>
                        <input type="password" id="signupPassword" minlength="6" required placeholder="Create a password">
                    </div>
                    <div class="form-group">
                        <label for="signupConfirm">Confirm Password</label>
                        <input type="password" id="signupConfirm" minlength="6" required placeholder="Confirm your password">
                    </div>
                    <button type="submit" class="btn">Sign Up</button>
                </form>
                
                <div class="divider"><span>or</span></div>
                
                <button id="googleSignupBtn" class="btn btn-outline" style="color: var(--dark); border-color: var(--light-gray);">
                    <svg style="width:20px;height:20px;margin-right:10px;" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"></path>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"></path>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"></path>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"></path>
                    </svg>
                    Sign up with Google
                </button>
                
                <div class="auth-footer">
                    Already have an account? <a href="#" id="showLoginLink">Log in</a>
                </div>
            </div>
        </div>

        <!-- Login View -->
        <div id="loginView" class="auth-container" style="display: none;">
            <div class="auth-card">
                <div class="auth-header">
                    <h2>Welcome Back</h2>
                    <p>Continue your journey to financial freedom</p>
                </div>
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn">Log In</button>
                </form>
                
                <div class="divider"><span>or</span></div>
                
                <button id="googleLoginBtn" class="btn btn-outline" style="color: var(--dark); border-color: var(--light-gray);">
                    <svg style="width:20px;height:20px;margin-right:10px;" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"></path>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"></path>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"></path>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"></path>
                    </svg>
                    Log in with Google
                </button>
                
                <div class="auth-footer">
                    Don't have an account? <a href="#" id="showSignupLink">Sign up</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="appView" class="app-view">
        <div class="container">
            <!-- Tab Navigation -->
            <div class="tabs">
                <div class="tab active" data-tab="loans">My Loans</div>
                <div class="tab" data-tab="payments">Payment History</div>
                <div class="tab" data-tab="privacy">Privacy Policy</div>
            </div>
            
            <!-- Tab Content -->
            <div id="loansTab" class="tab-content active">
                <!-- Add Loan Form -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Add New Loan</h2>
                    </div>
                    <form id="loanForm">
                        <div class="form-group">
                            <label for="loanName">Loan Name</label>
                            <input type="text" id="loanName" placeholder="e.g., Credit Card, Student Loan" required>
                        </div>
                        
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="loanBalance">Current Balance ($)</label>
                                <input type="number" id="loanBalance" min="0" step="0.01" placeholder="5000" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="interestRate">Interest Rate (%)</label>
                                <input type="number" id="interestRate" min="0" step="0.01" placeholder="7.5" required>
                            </div>
                        </div>
                        
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="minPayment">Minimum Payment ($)</label>
                                <input type="number" id="minPayment" min="0" step="0.01" placeholder="100" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="strategy">Payoff Strategy</label>
                                <select id="strategy">
                                    <option value="avalanche">Avalanche (Highest Interest First)</option>
                                    <option value="snowball">Snowball (Lowest Balance First)</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn">Add Loan</button>
                    </form>
                </div>
                
                <!-- Loans Dashboard -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Your Loans</h2>
                        <button id="resetBtn" class="btn btn-danger btn-sm">Reset All</button>
                    </div>
                    
                    <div id="loansContainer" class="loans-grid">
                        <!-- Loan cards will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Payment History Tab -->
            <div id="paymentsTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Payment History</h2>
                    </div>
                    
                    <div id="historyContainer">
                        <!-- Payment history will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Privacy Policy Tab -->
            <div id="privacyTab" class="tab-content">
                <div class="privacy-container">
                    <h1>Privacy Policy</h1>
                    <p>Last updated: August 14, 2025</p>
                    
                    <p>DebtFree Compass ("us", "we", or "our") operates the DebtFree Compass application. This page informs you of our policies regarding the collection, use, and disclosure of personal data when you use our Service and the choices you have associated with that data.</p>
                    
                    <h2>Information Collection and Use</h2>
                    <p>We collect several different types of information for various purposes to provide and improve our Service to you.</p>
                    
                    <h3>Types of Data Collected</h3>
                    <ul>
                        <li><strong>Personal Data:</strong> When you register, we collect your email address. If you authenticate with Google, we collect your name and profile picture.</li>
                        <li><strong>Financial Data:</strong> We collect information about your loans and payments that you voluntarily provide to use our Service.</li>
                        <li><strong>Usage Data:</strong> We may collect information on how the Service is accessed and used.</li>
                    </ul>
                    
                    <h2>Use of Data</h2>
                    <p>DebtFree Compass uses the collected data for various purposes:</p>
                    <ul>
                        <li>To provide and maintain our Service</li>
                        <li>To notify you about changes to our Service</li>
                        <li>To allow you to participate in interactive features of our Service</li>
                        <li>To provide customer support</li>
                        <li>To gather analysis or valuable information so we can improve our Service</li>
                        <li>To monitor the usage of our Service</li>
                    </ul>
                    
                    <h2>Data Storage and Security</h2>
                    <p>We use Firebase Authentication and Firestore to securely store your data. We implement security measures to protect against unauthorized access to or unauthorized alteration, disclosure, or destruction of data.</p>
                    
                    <h2>Changes to This Privacy Policy</h2>
                    <p>We may update our Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page.</p>
                    
                    <h2>Contact Us</h2>
                    <p>If you have any questions about this Privacy Policy, please contact us at privacy@debtfreecompass.com</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="copyright">Â© 2025 DebtFree Compass. All rights reserved.</div>
                <div class="footer-links">
                    <a href="#" data-tab="privacy">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Contact Us</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD6uE1Up7u-9W4VsFvZbwvVuWHYV7YBR8o",
            authDomain: "debt-tracker-f1363.firebaseapp.com",
            projectId: "debt-tracker-f1363",
            storageBucket: "debt-tracker-f1363.firebasestorage.app",
            messagingSenderId: "1084322691260",
            appId: "1:1084322691260:web:1d1132a91a503344c4f8b9",
            measurementId: "G-CRZ34K0KWK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // DOM Elements
        const elements = {
            // Auth Views
            authViews: document.getElementById('authViews'),
            signupView: document.getElementById('signupView'),
            loginView: document.getElementById('loginView'),
            signupForm: document.getElementById('signupForm'),
            loginForm: document.getElementById('loginForm'),
            googleSignupBtn: document.getElementById('googleSignupBtn'),
            googleLoginBtn: document.getElementById('googleLoginBtn'),
            showLoginLink: document.getElementById('showLoginLink'),
            showSignupLink: document.getElementById('showSignupLink'),
            
            // App View
            appView: document.getElementById('appView'),
            loanForm: document.getElementById('loanForm'),
            loansContainer: document.getElementById('loansContainer'),
            resetBtn: document.getElementById('resetBtn'),
            historyContainer: document.getElementById('historyContainer'),
            
            // Auth Buttons
            authButtons: document.getElementById('authButtons'),
            loginBtn: document.getElementById('loginBtn'),
            signupBtn: document.getElementById('signupBtn'),
            userSection: document.getElementById('userSection'),
            userAvatar: document.getElementById('userAvatar'),
            logoutBtn: document.getElementById('logoutBtn'),
            
            // Tabs
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            // Toast
            toast: document.getElementById('toast')
        };

        // App State
        const state = {
            currentUser: null,
            loans: [],
            payments: []
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            initAuthState();
        }

        // Initialize Firebase auth state listener
        function initAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    state.currentUser = user;
                    showAppView();
                    loadUserData();
                    analytics.logEvent('login', { method: user.providerData[0].providerId });
                } else {
                    // User is signed out
                    state.currentUser = null;
                    showAuthView();
                }
            });
        }

        // Show auth views
        function showAuthView() {
            elements.authViews.style.display = 'flex';
            elements.appView.style.display = 'none';
            elements.authButtons.style.display = 'flex';
            elements.userSection.style.display = 'none';
            showSignupView();
        }

        // Show app view
        function showAppView() {
            elements.authViews.style.display = 'none';
            elements.appView.style.display = 'block';
            elements.authButtons.style.display = 'none';
            elements.userSection.style.display = 'flex';
            
            // Set up user avatar
            if (state.currentUser.photoURL) {
                elements.userAvatar.innerHTML = `<img src="${state.currentUser.photoURL}" alt="User Avatar">`;
            } else {
                const initials = state.currentUser.email.charAt(0).toUpperCase();
                elements.userAvatar.textContent = initials;
            }
        }

        // Show signup view
        function showSignupView() {
            elements.signupView.style.display = 'flex';
            elements.loginView.style.display = 'none';
        }

        // Show login view
        function showLoginView() {
            elements.signupView.style.display = 'none';
            elements.loginView.style.display = 'flex';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth navigation
            elements.signupBtn.addEventListener('click', showSignupView);
            elements.loginBtn.addEventListener('click', showLoginView);
            elements.showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                showLoginView();
            });
            elements.showSignupLink.addEventListener('click', (e) => {
                e.preventDefault();
                showSignupView();
            });
            
            // Auth forms
            elements.signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = elements.signupEmail.value;
                const password = elements.signupPassword.value;
                const confirm = elements.signupConfirm.value;
                
                // Form validation
                if (password !== confirm) {
                    showToast('Passwords do not match', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showToast('Password must be at least 6 characters', 'error');
                    return;
                }
                
                signUpWithEmail(email, password);
            });
            
            elements.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = elements.loginEmail.value;
                const password = elements.loginPassword.value;
                
                signInWithEmail(email, password);
            });
            
            // Google sign in/up
            elements.googleSignupBtn.addEventListener('click', signInWithGoogle);
            elements.googleLoginBtn.addEventListener('click', signInWithGoogle);
            
            // Logout
            elements.logoutBtn.addEventListener('click', signOut);
            
            // Loan form
            elements.loanForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addLoan();
            });
            
            // Reset button
            elements.resetBtn.addEventListener('click', resetLoans);
            
            // Tab navigation
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Footer links
            document.querySelectorAll('.footer-links a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = link.getAttribute('data-tab');
                    if (tabId) {
                        switchTab(tabId);
                    }
                });
            });
        }

        // Sign up with email/password
        function signUpWithEmail(email, password) {
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showToast('Account created successfully!', 'success');
                    analytics.logEvent('sign_up', { method: 'email' });
                })
                .catch((error) => {
                    showToast(error.message, 'error');
                });
        }

        // Sign in with email/password
        function signInWithEmail(email, password) {
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showToast('Login successful!', 'success');
                    analytics.logEvent('login', { method: 'email' });
                })
                .catch((error) => {
                    showToast(error.message, 'error');
                });
        }

        // Sign in with Google
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    showToast('Signed in with Google', 'success');
                    analytics.logEvent('login', { method: 'google' });
                })
                .catch((error) => {
                    showToast(error.message, 'error');
                });
        }

        // Sign out
        function signOut() {
            auth.signOut()
                .then(() => {
                    showToast('You have been signed out', 'info');
                })
                .catch((error) => {
                    showToast(error.message, 'error');
                });
        }

        // Load user data from Firestore
        function loadUserData() {
            if (!state.currentUser) return;
            
            const userId = state.currentUser.uid;
            
            // Load loans
            db.collection('users').doc(userId).collection('loans').get()
                .then((querySnapshot) => {
                    state.loans = [];
                    querySnapshot.forEach((doc) => {
                        state.loans.push({ id: doc.id, ...doc.data() });
                    });
                    renderLoans();
                    analytics.logEvent('loans_loaded', { count: state.loans.length });
                })
                .catch((error) => {
                    showToast('Error loading loans: ' + error.message, 'error');
                });
            
            // Load payments
            db.collection('users').doc(userId).collection('payments').get()
                .then((querySnapshot) => {
                    state.payments = [];
                    querySnapshot.forEach((doc) => {
                        state.payments.push({ id: doc.id, ...doc.data() });
                    });
                    renderPaymentHistory();
                })
                .catch((error) => {
                    showToast('Error loading payments: ' + error.message, 'error');
                });
        }

        // Add a new loan
        function addLoan() {
            if (!state.currentUser) return;
            
            const loan = {
                name: elements.loanName.value,
                balance: parseFloat(elements.loanBalance.value),
                interestRate: parseFloat(elements.interestRate.value),
                minPayment: parseFloat(elements.minPayment.value),
                strategy: elements.strategy.value,
                payoffDate: calculatePayoffDate(
                    parseFloat(elements.loanBalance.value),
                    parseFloat(elements.interestRate.value),
                    parseFloat(elements.minPayment.value)
                ),
                totalInterest: 0,
                paid: 0,
                payments: []
            };
            
            const userId = state.currentUser.uid;
            
            // Add to Firestore
            db.collection('users').doc(userId).collection('loans').add(loan)
                .then((docRef) => {
                    loan.id = docRef.id;
                    state.loans.push(loan);
                    renderLoans();
                    elements.loanForm.reset();
                    showToast('Loan added successfully!', 'success');
                    analytics.logEvent('add_loan', { name: loan.name, amount: loan.balance });
                })
                .catch((error) => {
                    showToast('Error adding loan: ' + error.message, 'error');
                });
        }

        // Calculate payoff date for a loan
        function calculatePayoffDate(balance, interestRate, minPayment) {
            // Simplified calculation for demo purposes
            const monthlyRate = interestRate / 100 / 12;
            let months = 0;
            let remaining = balance;
            
            while (remaining > 0) {
                months++;
                const interest = remaining * monthlyRate;
                const principalPayment = minPayment - interest;
                remaining -= principalPayment;
                
                if (remaining < 0) remaining = 0;
            }
            
            const payoffDate = new Date();
            payoffDate.setMonth(payoffDate.getMonth() + months);
            return payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        // Render loans to the dashboard
        function renderLoans() {
            if (state.loans.length === 0) {
                elements.loansContainer.innerHTML = `
                    <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>No Loans Added Yet</h3>
                        <p>Get started by adding your first loan using the form above.</p>
                    </div>
                `;
                return;
            }
            
            elements.loansContainer.innerHTML = '';
            
            state.loans.forEach(loan => {
                const paidAmount = 0; // To be implemented with payments
                const paidPercentage = 0; // To be implemented with payments
                
                const loanCard = document.createElement('div');
                loanCard.className = 'loan-card';
                loanCard.innerHTML = `
                    <div class="loan-header">
                        <div class="loan-name">${loan.name}</div>
                        <div class="loan-details">
                            <span>${loan.interestRate}% APR</span>
                            <span>Min: $${loan.minPayment.toFixed(2)}/mo</span>
                        </div>
                    </div>
                    <div class="loan-body">
                        <div class="loan-stats">
                            <div class="stat">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value">$${loan.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Interest</div>
                                <div class="stat-value">$${loan.totalInterest.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Payoff Date</div>
                                <div class="stat-value">${loan.payoffDate}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Strategy</div>
                                <div class="stat-value">${loan.strategy === 'avalanche' ? 'Avalanche' : 'Snowball'}</div>
                            </div>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress" style="width: ${paidPercentage}%;"></div>
                        </div>
                        
                        <div class="payment-form">
                            <h4>Make a Payment</h4>
                            <div class="payment-row">
                                <div class="payment-input">
                                    <span>$</span>
                                    <input type="number" class="payment-amount" min="${loan.minPayment.toFixed(2)}" step="0.01" value="${loan.minPayment.toFixed(2)}">
                                </div>
                                <button class="btn btn-secondary btn-sm record-payment" data-id="${loan.id}">Record Payment</button>
                            </div>
                        </div>
                    </div>
                    <div class="loan-footer">
                        <button class="btn btn-sm btn-outline view-history" data-id="${loan.id}">View History</button>
                        <button class="btn btn-sm btn-danger remove-loan" data-id="${loan.id}">Remove</button>
                    </div>
                `;
                
                elements.loansContainer.appendChild(loanCard);
                
                // Add event listeners to buttons
                loanCard.querySelector('.record-payment').addEventListener('click', function() {
                    const loanId = this.getAttribute('data-id');
                    const amount = parseFloat(loanCard.querySelector('.payment-amount').value);
                    recordPayment(loanId, amount);
                });
                
                loanCard.querySelector('.remove-loan').addEventListener('click', function() {
                    const loanId = this.getAttribute('data-id');
                    removeLoan(loanId);
                });
                
                loanCard.querySelector('.view-history').addEventListener('click', function() {
                    const loanId = this.getAttribute('data-id');
                    showLoanHistory(loanId);
                });
            });
        }

        // Record a payment
        function recordPayment(loanId, amount) {
            if (!state.currentUser) return;
            
            const loan = state.loans.find(l => l.id === loanId);
            if (!loan) return;
            
            if (amount < loan.minPayment) {
                showToast(`Payment must be at least $${loan.minPayment.toFixed(2)}`, 'error');
                return;
            }
            
            const payment = {
                loanId: loanId,
                loanName: loan.name,
                amount: amount,
                date: new Date().toLocaleDateString('en-US'),
                interest: amount * (loan.interestRate / 100 / 12),
                principal: amount - (amount * (loan.interestRate / 100 / 12))
            };
            
            const userId = state.currentUser.uid;
            
            // Add to Firestore
            db.collection('users').doc(userId).collection('payments').add(payment)
                .then((docRef) => {
                    payment.id = docRef.id;
                    state.payments.push(payment);
                    renderPaymentHistory();
                    showToast('Payment recorded!', 'success');
                    analytics.logEvent('record_payment', { loanId: loanId, amount: amount });
                })
                .catch((error) => {
                    showToast('Error recording payment: ' + error.message, 'error');
                });
        }

        // Render payment history
        function renderPaymentHistory() {
            if (state.payments.length === 0) {
                elements.historyContainer.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <h3>No Payments Recorded Yet</h3>
                        <p>Make your first payment to see it appear here.</p>
                    </div>
                `;
                return;
            }
            
            // Sort payments by date (newest first)
            const sortedPayments = [...state.payments].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `
                <div class="card">
                    <h3>Payment History</h3>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Loan</th>
                                <th>Amount</th>
                                <th>Principal</th>
                                <th>Interest</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedPayments.forEach(payment => {
                html += `
                    <tr>
                        <td>${payment.date}</td>
                        <td>${payment.loanName}</td>
                        <td>$${payment.amount.toFixed(2)}</td>
                        <td>$${payment.principal.toFixed(2)}</td>
                        <td>$${payment.interest.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            elements.historyContainer.innerHTML = html;
        }

        // Show loan-specific payment history
        function showLoanHistory(loanId) {
            const loan = state.loans.find(l => l.id === loanId);
            if (!loan) return;
            
            const loanPayments = state.payments.filter(p => p.loanId === loanId);
            
            if (loanPayments.length === 0) {
                elements.historyContainer.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <h3>No Payments for ${loan.name}</h3>
                        <p>Make your first payment to see it appear here.</p>
                    </div>
                `;
                return;
            }
            
            // Sort payments by date (newest first)
            const sortedPayments = [...loanPayments].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Payment History: ${loan.name}</h3>
                        <button class="btn btn-sm btn-outline" id="backToAll">Back to All Payments</button>
                    </div>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Principal</th>
                                <th>Interest</th>
                                <th>Balance After</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Calculate running balance
            let runningBalance = loan.balance;
            
            sortedPayments.forEach(payment => {
                runningBalance -= payment.principal;
                
                html += `
                    <tr>
                        <td>${payment.date}</td>
                        <td>$${payment.amount.toFixed(2)}</td>
                        <td>$${payment.principal.toFixed(2)}</td>
                        <td>$${payment.interest.toFixed(2)}</td>
                        <td>$${runningBalance.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            elements.historyContainer.innerHTML = html;
            
            // Add event listener to back button
            document.getElementById('backToAll').addEventListener('click', () => {
                renderPaymentHistory();
                switchTab('payments');
            });
            
            // Switch to payment history tab
            switchTab('payments');
        }

        // Remove a loan
        function removeLoan(loanId) {
            if (!state.currentUser || !confirm('Are you sure you want to remove this loan?')) return;
            
            const userId = state.currentUser.uid;
            
            // Remove from Firestore
            db.collection('users').doc(userId).collection('loans').doc(loanId).delete()
                .then(() => {
                    // Remove from local state
                    state.loans = state.loans.filter(loan => loan.id !== loanId);
                    renderLoans();
                    showToast('Loan removed successfully', 'success');
                    analytics.logEvent('remove_loan', { loanId: loanId });
                })
                .catch((error) => {
                    showToast('Error removing loan: ' + error.message, 'error');
                });
        }

        // Reset all loans
        function resetLoans() {
            if (!state.currentUser || !confirm('Are you sure you want to reset all loans?')) return;
            
            const userId = state.currentUser.uid;
            
            // Delete all loans from Firestore
            const batch = db.batch();
            state.loans.forEach(loan => {
                const loanRef = db.collection('users').doc(userId).collection('loans').doc(loan.id);
                batch.delete(loanRef);
            });
            
            batch.commit()
                .then(() => {
                    state.loans = [];
                    renderLoans();
                    showToast('All loans have been reset', 'success');
                    analytics.logEvent('reset_loans');
                })
                .catch((error) => {
                    showToast('Error resetting loans: ' + error.message, 'error');
                });
        }

        // Switch tabs
        function switchTab(tabId) {
            // Update tab navigation
            elements.tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Update tab content
            elements.tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId + 'Tab') {
                    content.classList.add('active');
                }
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            elements.toast.textContent = message;
            elements.toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
